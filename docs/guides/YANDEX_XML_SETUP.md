# Настройка Яндекс XML API

## Что такое Яндекс XML API?

Яндекс XML API — это сервис для получения результатов поиска Яндекса в формате XML. Используется для автоматического получения результатов поиска в проекте LeadGen Constructor.

## Как получить ключи API

### Вариант 1: Официальный Яндекс XML API

1. Перейдите на https://yandex.ru/dev/xml/
2. Зарегистрируйтесь или войдите в аккаунт Яндекс
3. Создайте новое приложение
4. Получите:
   - **User ID** (user) — уникальный идентификатор пользователя
   - **API Key** (key) — ключ для доступа к API

**Примечание**: Официальный API может быть ограничен. В этом случае используйте сторонние прокси-сервисы.

### Вариант 2: Сторонние прокси-сервисы

Популярные сервисы:
- **XMLRiver**: https://xmlriver.com/
- **XMLStock**: https://xmlstock.com/

Эти сервисы предоставляют доступ к Яндекс XML API через свои прокси.

## Настройка в проекте

### 1. Добавить ключи в .env

Скопируйте `.env.example` в `.env` и добавьте:

```env
YANDEX_XML_USER=your_user_id_here
YANDEX_XML_KEY=your_api_key_here
# Опционально: если используете сторонний прокси-сервис
# YANDEX_XML_URL=https://xmlriver.com/yandex/xml
# или
# YANDEX_XML_URL=https://xmlstock.com/yandex/xml/
```

### 2. Перезапустить сервисы

После добавления ключей перезапустите backend:

```bash
docker compose restart backend
```

Или если запускаете локально:

```bash
# Остановить текущий процесс
# Запустить заново
uvicorn app.main:app --reload
```

## Как это работает

### Процесс поиска

1. Пользователь создает поиск через API: `POST /api/v1/searches`
2. Backend запускает Celery задачу `execute_search_task`
3. Задача вызывает `yandex_xml.fetch_search_results()`
4. Если ключи не настроены, возвращаются mock-данные для тестирования
5. Если ключи настроены, делается запрос к Яндекс XML API
6. Результаты парсятся из XML и сохраняются в БД

### Параметры запроса

- **query** — поисковый запрос (максимум 40 слов, 400 символов)
- **num_results** — количество результатов (максимум 100)
- **region** — ID региона поиска (213 = Москва, 1 = Санкт-Петербург и т.д.)

### Регионы поиска

Список регионов: https://yandex.ru/dev/xml/doc/dg/reference/regions.html

Популярные регионы:
- 213 — Москва
- 1 — Санкт-Петербург
- 2 — Екатеринбург
- 54 — Новосибирск
- 159 — Казань

## Ограничения API

- **Лимит запросов**: Зависит от тарифа Яндекс XML API
- **Результатов на страницу**: 10 результатов (API автоматически делает несколько запросов для получения большего количества)
- **Таймаут**: 30 секунд на запрос
- **Формат ответа**: XML

## Mock-режим

Если ключи не настроены, API возвращает mock-данные для тестирования:
- 10 mock результатов
- Все результаты с доменами `example1.com`, `example2.com` и т.д.

Это позволяет тестировать функциональность без реального API ключа.

## Обработка ошибок

API обрабатывает следующие ошибки:

- **HTTP ошибки** (4xx, 5xx) — возвращается `ValueError` с описанием
- **Ошибки парсинга XML** — возвращается `ValueError` с описанием
- **Ошибки API** (из XML ответа) — возвращается `ValueError` с кодом и текстом ошибки

## Примеры использования

### Создание поиска через API

```bash
curl -X POST http://localhost:8000/api/v1/searches \
  -H 'Content-Type: application/json' \
  -d '{
    "query": "ремонт окон Москва",
    "num_results": 50
  }'
```

### Проверка результатов

```bash
# Получить список поисков
curl http://localhost:8000/api/v1/searches

# Получить результаты поиска
curl http://localhost:8000/api/v1/searches/{id}/results
```

## Troubleshooting

### Проблема: Возвращаются mock-данные

**Причина**: Ключи API не настроены или неверны

**Решение**:
1. Проверьте `.env` файл — есть ли `YANDEX_XML_USER` и `YANDEX_XML_KEY`
2. Проверьте, что значения не пустые
3. Перезапустите backend после изменения `.env`

### Проблема: Ошибка "Yandex XML API error"

**Причина**: Неверный ключ или превышен лимит запросов

**Решение**:
1. Проверьте правильность ключей на https://yandex.ru/dev/xml/
2. Проверьте лимиты вашего тарифа
3. Подождите, если превышен лимит запросов

### Проблема: Медленные запросы

**Причина**: Яндекс XML API может быть медленным при большом количестве результатов

**Решение**:
- Уменьшите `num_results` (например, до 20-30)
- API автоматически делает несколько запросов для получения большего количества результатов

## Дополнительная информация

- Официальная документация: https://yandex.ru/dev/xml/doc/dg/concepts/about.html
- Список регионов: https://yandex.ru/dev/xml/doc/dg/reference/regions.html
- Параметры запроса: https://yandex.ru/dev/xml/doc/dg/reference/request.html
