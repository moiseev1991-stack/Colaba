# HTML Провайдеры поиска (Яндекс и Google)

## Обзор

HTML провайдеры парсят результаты обычного поиска Яндекса и Google без использования платных API. Это бесплатная альтернатива официальным API, но требует специальных мер защиты от блокировок.

## Доступные провайдеры

### Яндекс HTML (`yandex_html`)

Парсит HTML страницы результатов поиска Яндекса.

**URL формата:** `https://yandex.ru/search/?text={query}&lr={region}&p={page}`

**Особенности:**
- Поддержка регионов России через параметр `lr` (213 = Москва, 1 = Санкт-Петербург)
- Пагинация через параметр `p` (0, 1, 2, ...)
- По 10 результатов на страницу

**Пример использования:**
```python
from app.modules.searches.providers.yandex_html import fetch_search_results

results = await fetch_search_results(
    query="ремонт окон Москва",
    num_results=50,
    region=213,  # Москва
)
```

### Google HTML (`google_html`)

Парсит HTML страницы результатов поиска Google.

**URL формата:** `https://www.google.com/search?q={query}&hl={lang}&gl={country}&start={start}`

**Особенности:**
- Поддержка языков через параметр `hl` (ru, en, и т.д.)
- Поддержка стран через параметр `gl` (ru, us, и т.д.)
- Пагинация через параметр `start` (0, 10, 20, ...)
- По 10 результатов на страницу

**Пример использования:**
```python
from app.modules.searches.providers.google_html import fetch_search_results

results = await fetch_search_results(
    query="ремонт окон Москва",
    num_results=50,
    lang="ru",
    country="ru",
)
```

## Защита от блокировок

### Автоматические меры

Система автоматически применяет следующие меры защиты:

1. **Ротация User-Agent** - каждый запрос использует случайный User-Agent из списка реалистичных браузеров
2. **Случайные задержки** - между запросами добавляются случайные задержки (1-3 секунды)
3. **Ретраи с экспоненциальной задержкой** - при ошибках автоматически повторяются запросы с увеличивающейся задержкой
4. **Детектирование блокировок** - автоматическое определение капчи и блокировок по ключевым словам и статус кодам
5. **Автоматический fallback** - при блокировке одного провайдера автоматически переключается на другой

### Настройка прокси (опционально)

Для дополнительной защиты от блокировок можно настроить прокси.

#### Через environment variables

Добавьте в `.env`:

```env
# Включить использование прокси
USE_PROXY=true

# Одиночный прокси
PROXY_URL=http://proxy.example.com:8080

# Или список прокси для ротации (через запятую)
PROXY_LIST=http://proxy1.example.com:8080,http://proxy2.example.com:8080,socks5://proxy3.example.com:1080
```

#### Форматы прокси

- HTTP: `http://proxy.example.com:8080`
- HTTPS: `https://proxy.example.com:8080`
- SOCKS5: `socks5://proxy.example.com:1080`

#### Приоритет

Если указаны и `PROXY_URL`, и `PROXY_LIST`, используется `PROXY_URL`.

Если указан `PROXY_LIST`, система случайно выбирает прокси из списка для каждого запроса.

## Детектирование блокировок

Система автоматически детектирует следующие типы блокировок:

### Статус коды
- **403 Forbidden** - доступ запрещен
- **429 Too Many Requests** - превышен лимит запросов

### Редиректы
- Яндекс: редирект на `/showcaptcha` или `/captcha`
- Google: редирект на `/sorry` или страницы с "unusual traffic"

### Ключевые слова в HTML
- "captcha", "капча"
- "проверка на робота"
- "unusual traffic"
- "verify you're not a robot"
- "blocked", "заблокирован"
- "access denied"

### Анализ размера ответа
- Маленькие страницы (< 1000 символов) с ключевыми словами блокировки считаются подозрительными

## Автоматический Fallback

При блокировке одного провайдера система автоматически пробует другие:

- **yandex_html** → yandex_xml → duckduckgo
- **google_html** → duckduckgo
- **yandex_xml** → yandex_html → duckduckgo
- **duckduckgo** → yandex_html → google_html

Fallback можно отключить, установив `enable_fallback=False` при вызове `fetch_search_results()`.

## Troubleshooting

### Проблема: Провайдер возвращает пустые результаты

**Возможные причины:**
1. Изменилась HTML структура страницы поиска
2. Блокировка IP
3. Капча

**Решения:**
1. Проверьте логи на наличие ошибок парсинга
2. Настройте прокси
3. Увеличьте задержки между запросами
4. Используйте fallback на другой провайдер

### Проблема: Частые блокировки

**Решения:**
1. **Настройте прокси** - это самый эффективный способ избежать блокировок
2. **Увеличьте задержки** - между запросами должно быть минимум 2-3 секунды
3. **Используйте ротацию прокси** - если используете `PROXY_LIST`, система автоматически ротирует прокси
4. **Ограничьте частоту запросов** - не делайте слишком много запросов одновременно

### Проблема: Парсер не находит результаты

**Возможные причины:**
1. Яндекс/Google изменили структуру HTML
2. Страница загрузилась не полностью
3. Блокировка (страница капчи вместо результатов)

**Решения:**
1. Проверьте HTML структуру страницы вручную
2. Обновите селекторы в коде парсера
3. Проверьте логи на наличие ошибок детектирования блокировок

## Best Practices

### Для Яндекс HTML

1. **Используйте разумные задержки** - минимум 2-3 секунды между запросами
2. **Настройте прокси** - особенно если делаете много запросов
3. **Мониторьте блокировки** - проверяйте логи на наличие предупреждений о блокировках
4. **Используйте fallback** - настройте автоматический fallback на Яндекс XML API или DuckDuckGo

### Для Google HTML

1. **Обязательно используйте прокси** - Google очень агрессивно блокирует ботов
2. **Увеличьте задержки** - минимум 3-5 секунд между запросами
3. **Ограничьте количество запросов** - не делайте больше 10-20 запросов в минуту
4. **Используйте fallback** - Google HTML имеет высокий риск блокировок, всегда настройте fallback

### Общие рекомендации

1. **Мониторинг** - следите за логами на наличие блокировок
2. **Тестирование** - регулярно тестируйте парсеры, так как структура HTML может измениться
3. **Резервные провайдеры** - всегда имейте резервный провайдер (DuckDuckGo или Яндекс XML API)
4. **Ограничение частоты** - не злоупотребляйте запросами, это может привести к блокировке IP

## Технические детали

### Структура HTML (Яндекс)

Яндекс использует следующие структуры (могут изменяться):

- Результаты в `<li class="serp-item">` или `<li class="organic">`
- Заголовок в `<h2 class="organic__title">` или `<a class="link">`
- URL в атрибуте `href` ссылки
- Snippet в `<div class="organic__text">` или `<span class="text-container">`

### Структура HTML (Google)

Google использует следующие структуры (могут изменяться):

- Результаты в `<div class="g">` или `<div class="tF2Cxc">`
- Заголовок в `<h3>` внутри результата
- URL в `<a>` с атрибутом `href` (может быть в формате `/url?q=...`)
- Snippet в `<div class="VwiC3b">` или `<span class="aCOpRe">`

### Обработка ошибок

При ошибке парсинга или блокировке:
1. Система логирует ошибку
2. Пробует fallback провайдер (если включен)
3. Возвращает частичные результаты, если удалось получить хотя бы часть
4. Выбрасывает исключение только если все провайдеры провалились

## Примеры использования

### Базовое использование

```python
from app.modules.searches.providers import fetch_search_results

# Яндекс HTML
results = await fetch_search_results(
    provider="yandex_html",
    query="ремонт окон Москва",
    num_results=50,
)

# Google HTML
results = await fetch_search_results(
    provider="google_html",
    query="ремонт окон Москва",
    num_results=50,
)
```

### С отключенным fallback

```python
results = await fetch_search_results(
    provider="yandex_html",
    query="ремонт окон Москва",
    num_results=50,
    enable_fallback=False,  # Не использовать fallback
)
```

### С дополнительными параметрами

```python
# Яндекс HTML с указанием региона
results = await fetch_search_results(
    provider="yandex_html",
    query="ремонт окон",
    num_results=50,
    region=1,  # Санкт-Петербург
)

# Google HTML с указанием языка и страны
results = await fetch_search_results(
    provider="google_html",
    query="window repair",
    num_results=50,
    lang="en",
    country="us",
)
```

## Ограничения

1. **Изменение HTML структуры** - при изменении структуры страниц поиска парсеры могут перестать работать и потребуют обновления
2. **Блокировки** - при частых запросах возможны блокировки IP, даже с защитными мерами
3. **Капчи** - поисковые системы могут показывать капчу, которую автоматически решить нельзя
4. **Производительность** - парсинг HTML медленнее чем использование API

## Альтернативы

Если HTML провайдеры не подходят из-за блокировок или других проблем:

1. **DuckDuckGo** - бесплатный, стабильный, низкий риск блокировок
2. **Яндекс XML API** - официальный API, требует ключи, но стабильный
3. **Комбинация** - используйте HTML провайдеры как основной источник с fallback на DuckDuckGo
